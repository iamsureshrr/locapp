<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location-Based Website</title>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let previousLocation = null; // To store the previous location for filtering
      const updateFrequency = 2000; // Check location every 2 seconds
      const allowedRadius = 10; // Radius in meters
      const orgLat = 12.9106072; // Organization's latitude
      const orgLng = 80.2274784; // Organization's longitude

      function getLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(checkLocation, showError, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
          });
        } else {
          document.body.innerHTML = "<h2>Geolocation is not supported by this browser.</h2>";
        }
      }

      function checkLocation(position) {
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;

        // Log the user's latitude and longitude to the console
        console.log("User's Latitude, Longitude: " + userLat + ", " + userLng);

        // Simple noise filtering
        if (previousLocation) {
          const distanceToPrevious = calculateDistance(userLat, userLng, previousLocation.lat, previousLocation.lng);
          if (distanceToPrevious > 5) { // Only accept changes greater than 5 meters
            previousLocation = { lat: userLat, lng: userLng }; // Update only if the new location is valid
          } else {
            return; // Ignore the update if it's too close to the previous location
          }
        } else {
          previousLocation = { lat: userLat, lng: userLng }; // Initialize on the first run
        }

        const distance = calculateDistance(userLat, userLng, orgLat, orgLng);
        console.log("Distance from allowed location: " + distance + " meters");

        // Check if user is within the allowed radius
        if (distance <= allowedRadius) {
          document.getElementById('content').innerHTML = `
            <h1>Congratulations! You are inside the cafeteria.</h1>
            <p>You can give your feedback.</p>`;
        } else {
          document.getElementById('content').innerHTML = `
            <h1>You are ${distance.toFixed(1)} meters away from the cafeteria.</h1>
            <p>Please go inside the cafeteria.</p>`;
        }
      }

      // Calculate the distance between two locations using the Haversine formula
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radius of the Earth in meters
        const φ1 = lat1 * (Math.PI / 180); // Convert degrees to radians
        const φ2 = lat2 * (Math.PI / 180);
        const Δφ = (lat2 - lat1) * (Math.PI / 180);
        const Δλ = (lon2 - lon1) * (Math.PI / 180);

        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const distance = R * c; // Distance in meters
        return distance;
      }

      function showError(error) {
        switch (error.code) {
          case error.PERMISSION_DENIED:
            document.body.innerHTML = "<h2>User denied the request for Geolocation.</h2>";
            break;
          case error.POSITION_UNAVAILABLE:
            document.body.innerHTML = "<h2>Location information is unavailable.</h2>";
            break;
          case error.TIMEOUT:
            document.body.innerHTML = "<h2>The request to get user location timed out.</h2>";
            break;
          case error.UNKNOWN_ERROR:
            document.body.innerHTML = "<h2>An unknown error occurred.</h2>";
            break;
        }
      }

      // Start location checks when the page loads
      getLocation();
      setInterval(getLocation, updateFrequency); // Check location at defined intervals
    });
  </script>
</head>
<body>
  <div id="content">
    <h2>Checking your location...</h2>
  </div>
</body>
</html>
